<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoSortha: Blockchain Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        
        :root {
            --primary-color: #4CAF50;
            --accent-color: #2c3e50;
        }

        header {
          background-color: rgba(255, 255, 255, 0.9);
          backdrop-filter: blur(5px);
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          padding: 20px 0;
          position: sticky;
          top: 0;
          z-index: 50;
        }
        .header-container {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .logo {
          display: flex;
          align-items: center;
          gap: 10px;
        }
        .logo i {
          font-size: 24px;
          color: var(--primary-color);
        }
        .logo-text {
          font-size: 1.5rem;
          font-weight: bold;
          color: var(--accent-color);
        }
        nav ul {
          display: flex;
          list-style: none;
          gap: 20px;
        }
        nav a {
          text-decoration: none;
          color: var(--accent-color);
          font-weight: 500;
          transition: all 0.3s ease;
          padding: 5px 10px;
          border-radius: 5px;
          position: relative;
        }
        nav a:hover {
          background-color: rgba(76, 175, 80, 0.1);
          color: var(--primary-color);
        }
        nav a.active {
          background-color: var(--primary-color);
          color: white;
        }
        .notif-badge {
          position: absolute;
          top: -6px;
          right: -6px;
          min-width: 18px;
          height: 18px;
          background: #ef4444;
          color: white;
          border-radius: 99px;
          font-size: 11px;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0 5px;
          line-height: 1;
          box-shadow: 0 0 0 2px white;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e8f5f3 0%, #d4ebe8 100%);
        }
        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .zone-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .zone-item:hover {
            background-color: #10b981;
            color: white;
        }
        .zone-item.active {
            background-color: #059669;
            color: white;
        }
        .citycorp-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .citycorp-item:hover {
            background-color: #f0fdf4;
        }
        .citycorp-item.active {
            background-color: #dcfce7;
            border-left: 4px solid #10b981;
        }
        .scroll-panel::-webkit-scrollbar {
            width: 6px;
        }
        .scroll-panel::-webkit-scrollbar-thumb {
            background-color: #10b981;
            border-radius: 3px;
        }
        .ledger-block {
            border-bottom: 1px solid #e5e7eb;
            padding: 12px;
            transition: background-color 0.5s ease;
        }
        .ledger-block:first-child {
            background-color: #dcfce7;
        }
        .blockchain-chain {
            position: relative;
        }
        .blockchain-chain::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #10b981 0%, #3b82f6 50%, #8b5cf6 75%, #f59e0b 100%);
            z-index: 0;
        }
        .blockchain-block {
            position: relative;
            z-index: 1;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* Weekly archive styles */
        .archive-card { padding: 12px; border-radius: 8px; border: 1px solid #e6e6e6; background: #fff; }
        .archive-item { display:flex; justify-content:space-between; gap:8px; align-items:center; padding:8px; border-radius:6px; border:1px solid #f1f5f9; }
        .archive-meta { font-size:0.9rem; color:#374151; }
        .archive-amount { font-weight:700; color:#065f46; }
        .archive-btn { font-size:0.85rem; color:#2563eb; cursor:pointer; }
        .archive-list-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    </style>
</head>
<body class="min-h-screen">
    
    <header>
      <div class="header-container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="logo">
          <i class="fas fa-recycle"></i>
          <div class="logo-text">EcoSortha</div>
        </div>
        <nav>
          <ul>
            <li><a href="dashboard.html" class="active">Dashboard</a></li> 
            <li><a href="https://shiny-fishstick-qpjqqrwv59g3x95p-8000.app.github.dev/">Analytics</a></li>
            <li><a href="Dustbin.html">Dustbin</a></li>
            <li><a href="routeopt.html">Route Optimization</a></li>
            <li><a href="notification.html" id="nav-notifications">Notifications <span id="notifBadge" class="notif-badge" style="display:none">0</span></a></li>
            <li><a href="#">Settings</a></li>
          </ul>
        </nav>
      </div>
    </header>
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-2xl shadow-xl p-8 mb-8 text-white">
            <h2 class="text-4xl font-bold mb-6">AI for a Circular Bangladesh</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white/15 backdrop-blur-md rounded-lg p-5 border border-white/20">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-bullseye text-2xl mr-3"></i>
                        <h3 class="font-bold text-lg">Mission</h3>
                    </div>
                    <p class="text-sm text-white/90">To digitize the informal waste sector and optimize municipal collection for a cleaner Bangladesh.</p>
                </div>
                <div class="bg-white/15 backdrop-blur-md rounded-lg p-5 border border-white/20">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-eye text-2xl mr-3"></i>
                        <h3 class="font-bold text-lg">Vision</h3>
                    </div>
                    <p class="text-sm text-white/90">To establish a transparent, data-driven Circular Economy platform powered by AI and secured by Blockchain.</p>
                </div>
                <div class="bg-white/15 backdrop-blur-md rounded-lg p-5 border border-white/20">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-link text-2xl mr-3"></i>
                        <h3 class="font-bold text-lg">Blockchain Traceability</h3>
                    </div>
                    <p class="text-sm text-white/90">Every transaction is an immutable block ensuring transparency and auditability for EPR compliance.</p>
                </div>
            </div>
        </div>

        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm mb-1">Total Plastic Collected</p>
                        <p class="text-3xl font-bold text-gray-800" id="totalPlastic">0 kg</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-4">
                        <i class="fas fa-trash text-3xl text-green-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm mb-1">Total Transactions</p>
                        <p class="text-3xl font-bold text-gray-800" id="totalTransactions">0</p>
                    </div>
                    <div class="bg-blue-100 rounded-full p-4">
                        <i class="fas fa-exchange-alt text-3xl text-blue-600"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm mb-1">Total Disbursed</p>
                        <p class="text-3xl font-bold text-gray-800" id="totalDisbursed">৳0</p>
                    </div>
                    <div class="bg-yellow-100 rounded-full p-4">
                        <i class="fas fa-coins text-3xl text-yellow-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-4 gap-6 mb-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-map-marked-alt mr-2 text-green-600"></i>
                        Select Zone
                    </h3>
                    <div id="zoneList" class="space-y-2"></div>
                </div>

                <!-- Weekly Archive panel -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="archive-list-header">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center">
                            <i class="fas fa-calendar-week mr-2 text-indigo-600"></i>
                            Weekly Archive 
                        </h3>
                        <div class="text-sm text-gray-500">per kg costing: <strong>20 ৳/kg</strong></div>
                    </div>
                    <div id="weeklyArchiveList" class="space-y-3 archive-card">
                        <!-- populated by JS -->
                    </div>
                    <div class="text-xs text-gray-500 mt-3">
                        Shows start/end dates, collected (kg), transactions, paid, platform fee (profit) and net paid to vendors.
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center">
                            <i class="fas fa-building mr-2 text-green-600"></i>
                            City Corporation Areas
                        </h3>
                        <span id="selectedZoneName" class="text-sm text-gray-500"></span>
                    </div>
                    <div id="cityCorpList" class="grid md:grid-cols-3 gap-4"></div>
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center">
                        <i class="fas fa-store mr-2 text-green-600"></i>
                        Vendors (Bhangari Shops)
                    </h3>
                    <span id="selectedCityCorpName" class="text-sm text-gray-500"></span>
                </div>
                <div id="vendorPanel" class="scroll-panel max-h-96 overflow-y-auto"></div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-green-600"></i>
                    Today's Transactions
                </h3>
                <div id="dailyTransactionsPanel" class="scroll-panel max-h-96 overflow-y-auto"></div>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center">
                    <i class="fas fa-upload mr-2 text-green-600"></i>
                    Area Log Submission
                </h3>
                <p class="text-sm text-red-600 mb-4">⚠️ Failure to submit daily logs results in automated fines and compliance risk.</p>
                <form id="submissionForm" onsubmit="handleSubmitData(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Select Your City Corp Area</label>
                            <select id="cityCorpSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Total Plastic Collected (Kg)</label>
                            <input type="number" step="0.01" id="totalKg" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Total Paid to Tokais (BDT)</label>
                            <input type="number" step="0.01" id="totalPaid" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200">
                            Submit to Blockchain
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-cube mr-2 text-green-600"></i>
                    Live Blockchain Ledger
                </h3>
                <div id="blockchainLedger" class="scroll-panel max-h-96 overflow-y-auto bg-gray-50 rounded-lg p-4 font-mono text-xs"></div>
            </div>
        </div>

        <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl shadow-2xl p-8 text-white">
            <h3 class="text-2xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-cubes mr-3"></i>Blockchain Traceability System
            </h3>
            <div class="blockchain-chain flex justify-between items-center py-8 px-4">
                <div class="blockchain-block text-center">
                    <div class="bg-green-600 w-20 h-20 rounded-xl flex items-center justify-center mb-3 mx-auto shadow-lg">
                        <i class="fas fa-user text-3xl"></i>
                    </div>
                    <p class="text-sm font-semibold">Tokai Collects</p>
                </div>
                <div class="blockchain-block text-center">
                    <div class="bg-blue-600 w-20 h-20 rounded-xl flex items-center justify-center mb-3 mx-auto shadow-lg">
                        <i class="fas fa-store text-3xl"></i>
                    </div>
                    <p class="text-sm font-semibold">Vendor Purchases</p>
                </div>
                <div class="blockchain-block text-center">
                    <div class="bg-purple-600 w-20 h-20 rounded-xl flex items-center justify-center mb-3 mx-auto shadow-lg">
                        <i class="fas fa-industry text-3xl"></i>
                    </div>
                    <p class="text-sm font-semibold">Recycler Processes</p>
                </div>
                <div class="blockchain-block text-center">
                    <div class="bg-yellow-600 w-20 h-20 rounded-xl flex items-center justify-center mb-3 mx-auto shadow-lg">
                        <i class="fas fa-lock text-3xl"></i>
                    </div>
                    <p class="text-sm font-semibold">Block Verified</p>
                </div>
            </div>
            <p class="text-center text-sm text-gray-300 mt-4">
                Every transaction is recorded as an immutable block, ensuring complete transparency and compliance with Extended Producer Responsibility (EPR) regulations.
            </p>
        </div>
    </main>

    <footer class="bg-white mt-12 py-6 border-t">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-600">
            <p>Smart Waste Management System by Team Gliders</p>
            <p class="text-sm mt-1">© 2025 All Rights Reserved</p>
        </div>
    </footer>

    <script>
        // STORAGE KEYS
        const STORAGE_KEY = 'ECO_APP_STATE_v1';
        const NOTIF_KEY = 'ECO_NOTIFICATIONS_v1';
        const WEEKLY_ARCHIVE_LIMIT = 5;
        const WEEK_MS = 7 * 24 * 60 * 60 * 1000;

        // CONSTANTS
        const PLATFORM_FEE_PERCENT = 0.05; // 5% platform fee
        const COST_PER_KG = 20; // per your request: 20 tk/kg for archive calculation

        // HELPERS
        function isToday(isoTimestamp) {
            if (!isoTimestamp) return false;
            const date = new Date(isoTimestamp);
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        function generateFakeHash() {
            return '0x' + [...Array(40)].map(() => Math.floor(Math.random() * 16).toString(16)).join('');
        }

        function safeParse(jsonStr, fallback) {
            try {
                return JSON.parse(jsonStr);
            } catch (e) { return fallback; }
        }

        function formatDateRange(startIso, endIso) {
            const s = new Date(startIso);
            const e = new Date(endIso);
            const opts = { year: 'numeric', month: 'short', day: 'numeric' };
            return `${s.toLocaleDateString(undefined, opts)} — ${e.toLocaleDateString(undefined, opts)}`;
        }

        // DEFAULT DATA MODEL (kept same as before)
        const YESTERDAY = new Date(new Date().setDate(new Date().getDate() - 1)).toISOString();

        let DATA = {
            zones: [
                { id: 1, name: "Dhaka North (DNCC)" },
                { id: 2, name: "Dhaka South (DSCC)" },
                { id: 3, name: "Khulna City (KCC)" },
                { id: 4, name: "Chittagong (CCC)" }
            ],
            cityCorps: [
                { id: 101, zoneId: 1, name: "Mirpur Zone", lastUpdate: YESTERDAY },
                { id: 102, zoneId: 1, name: "Uttara Zone", lastUpdate: new Date().toISOString() },
                { id: 103, zoneId: 1, name: "Mohammadpur Zone", lastUpdate: YESTERDAY },
                { id: 104, zoneId: 2, name: "Jatrabari Zone", lastUpdate: YESTERDAY },
                { id: 105, zoneId: 2, name: "Lalbagh Zone", lastUpdate: new Date().toISOString() },
                { id: 106, zoneId: 2, name: "Motijheel Zone", lastUpdate: YESTERDAY },
                { id: 107, zoneId: 3, name: "Khulna West Zone", lastUpdate: new Date().toISOString() },
                { id: 108, zoneId: 3, name: "Rupsha Zone", lastUpdate: YESTERDAY },
                { id: 109, zoneId: 4, name: "Agrabad Zone", lastUpdate: YESTERDAY },
                { id: 110, zoneId: 4, name: "Port Area Zone", lastUpdate: new Date().toISOString() }
            ],
            vendors: [
                { vendorId: 1001, cityCorpId: 101, name: "Mirpur Bhangari Hub", collectedDailyKg: 150, amountPaidBDT: 3750 },
                { vendorId: 1002, cityCorpId: 101, name: "Shah Ali Traders", collectedDailyKg: 110, amountPaidBDT: 2750 },
                { vendorId: 1003, cityCorpId: 102, name: "Uttara Eco Traders", collectedDailyKg: 95, amountPaidBDT: 2375 },
                { vendorId: 1004, cityCorpId: 102, name: "Fatema Khatun Waste", collectedDailyKg: 85, amountPaidBDT: 2125 },
                { vendorId: 1005, cityCorpId: 103, name: "Mohammadpur Recyclers", collectedDailyKg: 200, amountPaidBDT: 5000 },
                { vendorId: 1006, cityCorpId: 104, name: "Firoza Akter Waste", collectedDailyKg: 180, amountPaidBDT: 4500 },
                { vendorId: 1007, cityCorpId: 104, name: "Jamil Mia Hub", collectedDailyKg: 70, amountPaidBDT: 1750 },
                { vendorId: 1008, cityCorpId: 105, name: "Purnima Rani Traders", collectedDailyKg: 130, amountPaidBDT: 3250 },
                { vendorId: 1009, cityCorpId: 105, name: "Habib Rahman Center", collectedDailyKg: 145, amountPaidBDT: 3625 },
                { vendorId: 1010, cityCorpId: 107, name: "Ayesha Siddika Waste", collectedDailyKg: 120, amountPaidBDT: 3000 },
                { vendorId: 1011, cityCorpId: 107, name: "Mizan Ali Aggregator", collectedDailyKg: 105, amountPaidBDT: 2625 },
                { vendorId: 1012, cityCorpId: 110, name: "Rashid Miah Port", collectedDailyKg: 160, amountPaidBDT: 4000 }
            ]
        };

        let blockchainLedger = [
            { hash: generateFakeHash(), timestamp: new Date().toISOString(), type: 'AREA_DAILY_LOG', data: 'Area 102 submitted 180kg / 4500 BDT' },
            { hash: generateFakeHash(), timestamp: YESTERDAY, type: 'AREA_DAILY_LOG', data: 'Area 105 submitted 275kg / 6875 BDT' },
            { hash: generateFakeHash(), timestamp: YESTERDAY, type: 'SYSTEM_AUDIT', data: 'Compliance check passed for Zone 1' }
        ];

        // Archive containers (persisted in app state)
        let archivedWeeks = [];     // [{ id, weekStart, weekEnd, totals: {...}, vendorSummaries: [...] }]
        let archivedLedger = [];    // older ledger entries

        // STATE
        let currentZoneId = 1;
        let selectedCityCorpId = null;

        // appState holder for cross-checks
        const appState = { lastWeeklyReset: null };

        // LOAD / SAVE APP STATE
        function saveAppState() {
            try {
                const state = {
                    DATA,
                    blockchainLedger,
                    archivedWeeks,
                    archivedLedger,
                    currentZoneId,
                    selectedCityCorpId,
                    lastSavedAt: new Date().toISOString(),
                    lastWeeklyReset: appState.lastWeeklyReset || null
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                updateNotifBadgeFromStorage();
            } catch (e) {
                console.error('saveAppState error', e);
            }
        }

        function loadAppState() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const state = safeParse(raw, null);
            if (!state) return;
            // load DATA parts
            if (state.DATA) {
                if (Array.isArray(state.DATA.vendors)) {
                    state.DATA.vendors.forEach(v => {
                        if (!v.createdAt) v.createdAt = new Date().toISOString();
                    });
                }
                DATA = Object.assign({}, DATA, state.DATA);
            }
            if (Array.isArray(state.blockchainLedger)) blockchainLedger = state.blockchainLedger;
            if (Array.isArray(state.archivedWeeks)) archivedWeeks = state.archivedWeeks;
            if (Array.isArray(state.archivedLedger)) archivedLedger = state.archivedLedger;
            if (state.currentZoneId) currentZoneId = state.currentZoneId;
            if (state.selectedCityCorpId) selectedCityCorpId = state.selectedCityCorpId;
            if (state.lastWeeklyReset) appState.lastWeeklyReset = state.lastWeeklyReset;
        }

        // --- WEEKLY ROLLOVER & ARCHIVE LOGIC ---
        function needsWeeklyReset() {
            if (!appState.lastWeeklyReset) return true;
            const last = new Date(appState.lastWeeklyReset).getTime();
            return (Date.now() - last) >= WEEK_MS;
        }

        // Create a weekly snapshot with weekStart/weekEnd, totals, platform fee (profit) and net paid
        function performWeeklyReset() {
            try {
                const nowIso = new Date().toISOString();
                // Determine weekStart: use previous lastWeeklyReset if present, otherwise use now - 7 days
                const weekStartIso = appState.lastWeeklyReset || new Date(Date.now() - WEEK_MS).toISOString();
                const weekEndIso = nowIso;

                // totals (note: for archive we use COST_PER_KG to compute totalDisbursed)
                const totalPlastic = DATA.vendors.reduce((sum, v) => sum + (parseFloat(v.collectedDailyKg) || 0), 0);
                const totalDisbursed = Math.round(totalPlastic * COST_PER_KG * 100) / 100;
                const totalTransactions = DATA.vendors.length + blockchainLedger.length;
                const platformFee = Math.round((totalDisbursed * PLATFORM_FEE_PERCENT) * 100) / 100;
                const netPaidToVendors = Math.round((totalDisbursed - platformFee) * 100) / 100;

                const vendorSummaries = DATA.vendors.map(v => ({
                    vendorId: v.vendorId,
                    cityCorpId: v.cityCorpId,
                    name: v.name,
                    collectedDailyKg: v.collectedDailyKg || 0,
                    amountPaidBDT: Math.round((v.collectedDailyKg || 0) * COST_PER_KG * 100) / 100
                }));

                const snapshot = {
                    id: Date.now(),
                    weekStart: weekStartIso,
                    weekEnd: weekEndIso,
                    totals: {
                        totalPlastic,
                        totalTransactions,
                        totalDisbursed,
                        platformFee,
                        netPaidToVendors
                    },
                    vendorSummaries
                };

                // push to archivedWeeks (limit to last N)
                archivedWeeks.unshift(snapshot);
                if (archivedWeeks.length > WEEKLY_ARCHIVE_LIMIT) archivedWeeks.length = WEEKLY_ARCHIVE_LIMIT;

                // 2) Move old ledger entries older than 7 days to archivedLedger
                const cutoff = Date.now() - WEEK_MS;
                const [recent, old] = partitionArray(blockchainLedger, b => new Date(b.timestamp).getTime() >= cutoff);
                archivedLedger = old.concat(archivedLedger);
                blockchainLedger = recent;

                // 3) Reset daily counters for vendors (we take snapshot above so we don't lose data)
                DATA.vendors.forEach(v => {
                    v.collectedDailyKg = 0;
                    v.amountPaidBDT = 0;
                    if (!v.createdAt) v.createdAt = new Date().toISOString();
                });

                // 4) update lastWeeklyReset and persist
                appState.lastWeeklyReset = weekEndIso;
                saveAppState();
                console.info('Weekly reset & archive performed at', appState.lastWeeklyReset);
            } catch (e) {
                console.error('performWeeklyReset error', e);
            }
        }

        function partitionArray(arr, predicate) {
            const a = [], b = [];
            for (const item of arr) {
                if (predicate(item)) a.push(item);
                else b.push(item);
            }
            return [a, b];
        }

        // If archive is empty, seed 4 weeks of sample data (per your request)
        function seedWeeklyArchiveIfEmpty() {
            if (archivedWeeks && archivedWeeks.length > 0) return;
            // We'll create 4 snapshots for the last 4 full weeks (weekEnd = today - offset*7 days)
            const now = Date.now();
            const weeks = [3,2,1,0]; // 4 weeks ago ... most recent week (relative)
            const samplesKg = [20000, 21500, 23000, 25000]; // sample collected kg per week
            archivedWeeks = weeks.map((wIndex, i) => {
                const weekEnd = new Date(now - (wIndex * WEEK_MS));
                const weekStart = new Date(weekEnd.getTime() - (WEEK_MS - (1000*60*60*24))); // inclusive 7 days
                const totalPlastic = samplesKg[i] || samplesKg[samplesKg.length - 1];
                const totalDisbursed = Math.round(totalPlastic * COST_PER_KG * 100) / 100;
                const platformFee = Math.round((totalDisbursed * PLATFORM_FEE_PERCENT) * 100) / 100;
                const netPaidToVendors = Math.round((totalDisbursed - platformFee) * 100) / 100;
                const totalTransactions = Math.max(50, Math.floor(totalPlastic / 50)); // simple heuristic

                // create a few vendor summaries (randomized small samples)
                const vendorSummaries = DATA.vendors.slice(0,6).map((v, idx) => {
                    const collected = Math.round((Math.random() * 0.08 + 0.04) * totalPlastic / 6); // fraction
                    return {
                        vendorId: v.vendorId,
                        cityCorpId: v.cityCorpId,
                        name: v.name,
                        collectedDailyKg: collected,
                        amountPaidBDT: Math.round(collected * COST_PER_KG * 100) / 100
                    };
                });

                return {
                    id: Date.now() - (wIndex * 1000),
                    weekStart: weekStart.toISOString(),
                    weekEnd: weekEnd.toISOString(),
                    totals: {
                        totalPlastic,
                        totalTransactions,
                        totalDisbursed,
                        platformFee,
                        netPaidToVendors
                    },
                    vendorSummaries
                };
            }).reverse(); // we want oldest first in array -> we'll reverse then later display newest first
            // keep newest first for display:
            archivedWeeks.reverse();
            // limit
            archivedWeeks = archivedWeeks.slice(0, WEEKLY_ARCHIVE_LIMIT);
            // persist
            saveAppState();
        }

        // check weekly rollover, run on load and periodically
        function checkAndRunWeeklyResetIfNeeded() {
            if (!appState.lastWeeklyReset) {
                appState.lastWeeklyReset = new Date().toISOString();
                saveAppState();
                return;
            }
            if (needsWeeklyReset()) {
                performWeeklyReset();
                updateDashboard();
            }
        }

        // Notifications storage helpers
        function defaultNotifications() {
            return [
                { id: Date.now()-60000, time: '5m ago', type: 'ALERT', icon: 'fas fa-exclamation-triangle', color: 'red', message: "CRITICAL ALERT: Daily Log for Mirpur Zone (Area 101) is overdue by 24 hours. Compliance Fine of ৳500 imposed.", read: false }
            ];
        }

        function loadNotifications() {
            const raw = localStorage.getItem(NOTIF_KEY);
            if (!raw) {
                const defaults = defaultNotifications();
                localStorage.setItem(NOTIF_KEY, JSON.stringify(defaults));
                return defaults;
            }
            return safeParse(raw, defaultNotifications());
        }

        function saveNotifications(list) {
            localStorage.setItem(NOTIF_KEY, JSON.stringify(list));
            updateNotifBadgeFromStorage();
        }

        function updateNotifBadgeFromStorage() {
            const list = loadNotifications();
            const unread = list.filter(n => !n.read).length;
            const badge = document.getElementById('notifBadge');
            if (badge) {
                if (unread > 0) {
                    badge.style.display = 'inline-flex';
                    badge.textContent = unread > 99 ? '99+' : unread;
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // RENDER FUNCTIONS (including weekly archive)
        function updateStatistics() {
            const totalPlastic = DATA.vendors.reduce((sum, v) => sum + (parseFloat(v.collectedDailyKg) || 0), 0);
            const totalTransactions = DATA.vendors.length + blockchainLedger.length;
            const totalDisbursed = DATA.vendors.reduce((sum, v) => sum + (parseFloat(v.amountPaidBDT) || 0), 0);

            document.getElementById('totalPlastic').textContent = totalPlastic.toLocaleString() + ' kg';
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('totalDisbursed').textContent = '৳' + totalDisbursed.toLocaleString();
        }

        function renderZones() {
            const html = DATA.zones.map(zone => `
                <div class="zone-item p-3 rounded-lg border border-gray-200 ${currentZoneId === zone.id ? 'active' : ''}" 
                     onclick="selectZone(${zone.id})">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-sm">${zone.name}</span>
                        <i class="fas fa-chevron-right text-xs"></i>
                    </div>
                    <div class="text-xs mt-1 opacity-75">
                        ${DATA.cityCorps.filter(c => c.zoneId === zone.id).length} areas
                    </div>
                </div>
            `).join('');
            document.getElementById('zoneList').innerHTML = html;
        }

        function renderCityCorps() {
            const cityCorps = DATA.cityCorps.filter(c => c.zoneId === currentZoneId);
            const zone = DATA.zones.find(z => z.id === currentZoneId);
            document.getElementById('selectedZoneName').textContent = zone ? `Zone: ${zone.name}` : '';

            if (cityCorps.length === 0) {
                document.getElementById('cityCorpList').innerHTML = '<p class="text-gray-500 text-center col-span-3">No areas in this zone</p>';
                return;
            }

            const html = cityCorps.map(cityCorp => {
                const isCompliant = isToday(cityCorp.lastUpdate);
                const statusBadge = isCompliant
                    ? '<span class="px-2 py-1 text-xs font-semibold bg-green-500 text-white rounded-full">✓ Verified</span>'
                    : '<span class="px-2 py-1 text-xs font-semibold bg-red-500 text-white rounded-full">⚠ Pending</span>';
                
                return `
                <div class="citycorp-item p-4 rounded-lg border border-gray-200 ${selectedCityCorpId === cityCorp.id ? 'active' : ''}" 
                     onclick="selectCityCorp(${cityCorp.id})">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-gray-800 text-sm">${cityCorp.name}</h4>
                        <i class="fas fa-building text-green-600"></i>
                    </div>
                    <div class="flex justify-between items-center">
                        ${statusBadge}
                        <span class="text-xs text-gray-500">${DATA.vendors.filter(v => v.cityCorpId === cityCorp.id).length} Vendors</span>
                    </div>
                </div>
            `}).join('');
            document.getElementById('cityCorpList').innerHTML = html;
        }

        function renderVendors() {
            if (!selectedCityCorpId) {
                document.getElementById('vendorPanel').innerHTML = '<p class="text-center text-gray-500 mt-8">Select a city corp area to view vendors</p>';
                return;
            }

            const cityCorp = DATA.cityCorps.find(c => c.id === selectedCityCorpId);
            const vendors = DATA.vendors.filter(v => v.cityCorpId === selectedCityCorpId);
            document.getElementById('selectedCityCorpName').textContent = cityCorp ? `Area: ${cityCorp.name}` : '';

            if (vendors.length === 0) {
                document.getElementById('vendorPanel').innerHTML = '<p class="text-center text-gray-500 mt-8">No vendors in this area</p>';
                return;
            }

            const html = vendors.map((vendor, i) => `
                <div class="p-4 mb-3 bg-gradient-to-br from-green-50 to-white rounded-lg border-l-4 border-green-500 fade-in" style="animation-delay: ${i * 0.1}s">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-sm font-bold text-gray-800">${vendor.name}</p>
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Active</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-600 mt-2">
                        <span>Collected: <strong class="text-green-700">${vendor.collectedDailyKg} kg</strong></span>
                        <span>Paid: <strong class="text-green-700">৳${vendor.amountPaidBDT}</strong></span>
                    </div>
                </div>
            `).join('');
            document.getElementById('vendorPanel').innerHTML = html;
        }

        function renderDailyTransactions() {
            const dailyBlocks = blockchainLedger.filter(block => isToday(block.timestamp));

            if (dailyBlocks.length === 0) {
                document.getElementById('dailyTransactionsPanel').innerHTML = '<p class="text-center text-gray-500 mt-4">No transactions submitted today.</p>';
                return;
            }

            const html = dailyBlocks.map(block => `
                <div class="p-4 mb-3 bg-gray-50 rounded-lg border-l-4 border-blue-500 fade-in">
                    <p class="text-sm font-bold text-gray-800">${block.type}</p>
                    <p class="text-xs text-gray-600 mb-2">${new Date(block.timestamp).toLocaleTimeString()}</p>
                    <p class="text-xs font-mono text-blue-700">${block.data}</p>
                </div>
            `).join('');
            
            document.getElementById('dailyTransactionsPanel').innerHTML = `
                <p class="text-sm text-gray-600 mb-4">A total of <strong class="text-lg text-green-600">${dailyBlocks.length}</strong> transactions have been added to the ledger today.</p>
                ${html}
            `;
        }

        function renderCityCorpDropdown() {
            const html = DATA.cityCorps.map(c => `<option value="${c.id}" ${selectedCityCorpId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            document.getElementById('cityCorpSelect').innerHTML = html;
        }
        
        function renderBlockchainLedger() {
            const html = blockchainLedger.map(block => `
                <div class="ledger-block">
                    <p class="text-blue-600">Hash: <span class="text-gray-600">${block.hash.substring(0, 30)}...</span></p>
                    <p class="text-gray-700">Timestamp: <span class="text-gray-600">${new Date(block.timestamp).toLocaleString()}</span></p>
                    <p class="text-green-700 font-semibold">Type: <span class="text-gray-800 font-normal">${block.type}</span></p>
                    <p class="text-green-700 font-semibold">Data: <span class="text-gray-800 font-normal">${block.data}</span></p>
                </div>
            `).join('');
            document.getElementById('blockchainLedger').innerHTML = html;
        }

        // Render weekly archive panel
        function renderWeeklyArchivePanel() {
            const container = document.getElementById('weeklyArchiveList');
            if (!container) return;
            if (!archivedWeeks || archivedWeeks.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No weekly archives yet.</p>';
                return;
            }
            // show newest first
            const list = archivedWeeks.slice().sort((a,b) => new Date(b.weekEnd) - new Date(a.weekEnd));
            const html = list.map((w, idx) => {
                const range = formatDateRange(w.weekStart, w.weekEnd);
                const totals = w.totals || {};
                return `
                    <div class="archive-item">
                        <div>
                            <div class="font-semibold">${range}</div>
                            <div class="archive-meta">
                                Collected: <span class="archive-amount">${totals.totalPlastic ?? 0} kg</span>
                                &nbsp;•&nbsp; Tx: <strong>${totals.totalTransactions ?? 0}</strong>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="archive-meta">Paid: ৳${(totals.totalDisbursed ?? 0).toLocaleString()}</div>
                            <div class="archive-meta">Fee: ৳${(totals.platformFee ?? 0).toLocaleString()}</div>
                            <div class="archive-btn mt-2" onclick="showArchiveDetail(${idx})">View</div>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = html;
        }

        // show archive detail modal (alert for now)
        function showArchiveDetail(index) {
            const list = archivedWeeks.slice().sort((a,b) => new Date(b.weekEnd) - new Date(a.weekEnd));
            const w = list[index];
            if (!w) return alert('Archive not available');
            const lines = [
                `Week: ${formatDateRange(w.weekStart, w.weekEnd)}`,
                `Transactions: ${w.totals.totalTransactions}`,
                `Total collected (kg): ${w.totals.totalPlastic}`,
                `Total disbursed (৳): ${w.totals.totalDisbursed}`,
                `Platform fee (৳): ${w.totals.platformFee}`,
                `Net paid to vendors (৳): ${w.totals.netPaidToVendors}`,
                '',
                'Top vendor summaries:'
            ];
            w.vendorSummaries.slice(0,8).forEach(v => lines.push(`${v.name} — ${v.collectedDailyKg} kg — ৳${v.amountPaidBDT}`));
            alert(lines.join('\n'));
        }

        // EVENT HANDLERS
        function selectZone(zoneId) {
            currentZoneId = zoneId;
            selectedCityCorpId = null;
            updateDashboard();
            saveAppState();
        }

        function selectCityCorp(cityCorpId) {
            selectedCityCorpId = cityCorpId;
            updateDashboard();
            saveAppState();
        }

        function handleSubmitData(event) {
            event.preventDefault();
            const form = event.target;
            const cityCorpId = parseInt(document.getElementById('cityCorpSelect').value);
            const totalKg = parseFloat(document.getElementById('totalKg').value);
            const totalPaid = parseFloat(document.getElementById('totalPaid').value);

            if (isNaN(cityCorpId) || isNaN(totalKg) || isNaN(totalPaid)) {
                alert("Please fill in all fields with valid numbers.");
                return;
            }

            const cityCorp = DATA.cityCorps.find(c => c.id === cityCorpId);
            if (cityCorp) {
                cityCorp.lastUpdate = new Date().toISOString();
            }
            
            const newVendor = {
                vendorId: Math.floor(Math.random() * 1000000),
                cityCorpId: cityCorpId,
                name: `Daily Log Summary (${new Date().toLocaleTimeString()})`,
                collectedDailyKg: totalKg,
                amountPaidBDT: totalPaid,
                createdAt: new Date().toISOString()
            };
            DATA.vendors.push(newVendor);

            const blockData = `Area ${cityCorpId} submitted ${totalKg}kg / ৳${totalPaid} BDT`;
            addBlockToLedger('AREA_DAILY_LOG', blockData);

            form.reset();
            updateDashboard();
            saveAppState();

            const submitBtn = form.querySelector('button');
            submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Success!';
            submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            submitBtn.classList.add('bg-blue-600');
            setTimeout(() => {
                submitBtn.innerHTML = 'Submit to Blockchain';
                submitBtn.classList.remove('bg-blue-600');
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            }, 2000);
        }
        
        function addBlockToLedger(type, data) {
            const newBlock = {
                hash: generateFakeHash(),
                timestamp: new Date().toISOString(),
                type: type,
                data: data,
            };
            blockchainLedger.unshift(newBlock);
            saveAppState();
        }

        // MASTER UPDATE FUNCTION
        function updateDashboard() {
            updateStatistics();
            renderZones();
            renderCityCorps();
            renderVendors();
            renderDailyTransactions();
            renderBlockchainLedger();
            renderCityCorpDropdown();
            renderWeeklyArchivePanel();
            updateNotifBadgeFromStorage();
        }

        // Initialize and weekly-check wiring
        window.addEventListener('load', () => {
            loadAppState();

            // If loaded state doesn't have vendor createdAt, add one to avoid undefined issues:
            DATA.vendors.forEach(v => { if (!v.createdAt) v.createdAt = new Date().toISOString(); });

            // Ensure archived arrays exist
            if (!archivedWeeks) archivedWeeks = [];
            if (!archivedLedger) archivedLedger = [];

            // Seed fixed 4-weeks sample data if archive empty (per your request)
            seedWeeklyArchiveIfEmpty();

            // If we never performed weekly reset previously, set pointer without resetting immediately:
            if (!appState.lastWeeklyReset) {
                appState.lastWeeklyReset = appState.lastWeeklyReset || new Date().toISOString();
                saveAppState();
            }

            // Run weekly reset if needed (if it's been more than a week)
            checkAndRunWeeklyResetIfNeeded();

            // Periodic check every hour in case the page stays open over the week boundary
            setInterval(() => {
                if (needsWeeklyReset()) {
                    performWeeklyReset();
                    updateDashboard();
                }
            }, 1000 * 60 * 60); // hourly

            // Initial render
            updateDashboard();
        });

        // Save on unload
        window.addEventListener('beforeunload', () => {
            saveAppState();
        });

        // Expose some objects for debugging in console
        window.__eco = {
            saveAppState,
            loadAppState,
            performWeeklyReset,
            DATA,
            blockchainLedger,
            archivedWeeks,
            archivedLedger,
            appState
        };
    </script>
</body>
</html>