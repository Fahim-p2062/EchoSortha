<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EcoSortha: Smart Dustbin Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      position: relative;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }

    :root {
      --primary-color: #4CAF50;
      --accent-color: #2c3e50;
      --low-color: #27ae60;
      --medium-color: #f39c12;
      --high-color: #e74c3c;
    }

    .svg-background {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -10;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    header {
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo i {
      font-size: 24px;
      color: var(--primary-color);
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent-color);
    }

    nav ul {
      display: flex;
      list-style: none;
      gap: 20px;
    }

    nav a {
      text-decoration: none;
      color: var(--accent-color);
      font-weight: 500;
      transition: all 0.3s ease;
      padding: 5px 10px;
      border-radius: 5px;
      position: relative;
    }

    nav a:hover {
      background-color: rgba(76, 175, 80, 0.1);
      color: var(--primary-color);
    }

    nav a.active {
      background-color: var(--primary-color);
      color: white;
    }

    .fill-meter {
      height: 20px;
      background-color: #eee;
      border-radius: 9999px;
      overflow: hidden;
      position: relative;
    }
    .fill-level {
      height: 100%;
      width: 0%;
      border-radius: 9999px;
      transition: width 1s ease, background-color 1s ease;
    }
    .fill-level.low { background-color: var(--low-color); }
    .fill-level.medium { background-color: var(--medium-color); }
    .fill-level.high { background-color: var(--high-color); }

    .status-badge {
      font-weight: bold;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      color: #fff;
      margin-top: 1.5rem;
      display: inline-block;
      min-width: 120px;
      text-align: center;
    }
    .status-badge.low { background-color: var(--low-color); }
    .status-badge.medium { background-color: var(--medium-color); }
    .status-badge.high { background-color: var(--high-color); }
    .status-badge.default { background-color: #9ca3af; }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 0.6;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.9;
      }
      100% {
        transform: scale(1);
        opacity: 0.6;
      }
    }
    .pulse-dot {
      animation: pulse 2s infinite;
    }

    .chatbot-section {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    .chatbot-toggle {
      position: absolute;
      bottom: 0;
      right: 0;
      background-color: var(--primary-color);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      z-index: 2;
    }

    .chatbot-toggle:hover {
      transform: scale(1.05);
    }

    .chatbot-container {
      position: absolute;
      bottom: 70px;
      right: 0;
      width: 350px;
      height: 450px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      transform: scale(0);
      transform-origin: bottom right;
      transition: transform 0.3s ease;
      opacity: 0;
    }

    .chatbot-container.active {
      transform: scale(1);
      opacity: 1;
    }

    .chatbot-header {
      padding: 15px;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chatbot-header h3 {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chatbot-header .close-chat {
      cursor: pointer;
      font-size: 18px;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #e74c3c;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
  </style>
</head>

<body class="min-h-screen">

  <div class="svg-background">
    <svg viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="backgroundGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#f0f9ff" />
          <stop offset="100%" stop-color="#d4f1e8" />
        </linearGradient>

        <pattern id="dustbinPattern" patternUnits="userSpaceOnUse" width="100" height="100"
          patternTransform="rotate(10)">
          <path d="M20,20 L40,20 L45,75 L15,75 Z" fill="#e0e0e0" opacity="0.2" />
        </pattern>

        <symbol id="recycleSymbol" viewBox="0 0 40 40">
          <path d="M31.7,22.3c-0.1-0.5-0.5-0.8-1-0.8h-4.1l2-3.5c0.2-0.4,0.1-0.9-0.2-1.2c-0.4-0.3-0.9-0.3-1.2,0.1l-3,5.2
          c-0.2,0.3-0.2,0.7,0,1c0.2,0.3,0.5,0.5,0.9,0.5h5.1c0.1,1.5-0.4,3-1.5,4.1c-1.8,1.8-4.7,1.8-6.5,0l-1.7-1.7
          c-0.3-0.3-0.9-0.3-1.2,0c-0.3,0.3-0.3,0.9,0,1.2l1.7,1.7c1.2,1.2,2.8,1.9,4.5,1.9c1.7,0,3.3-0.6,4.5-1.9
          C31.1,27.1,31.9,24.7,31.7,22.3z" fill="#4CAF50" />
          <path d="M23.3,8.9c-1.2-1.2-2.8-1.9-4.5-1.9c-1.7,0-3.3,0.6-4.5,1.9c-1.9,1.9-2.5,4.5-1.7,6.9c0.1,0.5,0.5,0.8,1,0.8
          h4.1l-2,3.5c-0.2,0.4-0.1,0.9,0.2,1.2c0.2,0.1,0.4,0.2,0.5,0.2c0.2,0,0.5-0.1,0.7-0.3l3-5.2c0.2-0.3,0.2-0.7,0-1
          c-0.2-0.3-0.5-0.5-0.9-0.5h-5.1c-0.1-1.5,0.4-3,1.5-4.1c1.8-1.8,4.7-1.8,6.5,0l1.7,1.7c0.3,0.3,0.9,0.3,1.2,0
          c0.3-0.3,0.3-0.9,0-1.2L23.3,8.9z" fill="#4CAF50" />
          <path d="M18.3,28c-0.2,0-0.5,0.1-0.7,0.3l-3,5.2c-0.2,0.3-0.2,0.7,0,1c0.2,0.3,0.5,0.5,0.9,0.5h10.1
          c0.5,0,1-0.4,1-0.9c0-0.5-0.4-1-0.9-1h-8.4l2-3.5c0.2-0.4,0.1-0.9-0.2-1.2C18.7,28.1,18.5,28,18.3,28z
          M16.7,28.2L16.7,28.2L16.7,28.2z" fill="#4CAF50" />
          <path d="M16.8,16.4c-1.9-1.9-4.6-2.5-7-1.7c-0.5,0.1-0.8,0.5-0.8,1v4.1l-3.5-2c-0.4-0.2-0.9-0.1-1.2,0.2
          c-0.3,0.4-0.3,0.9,0.1,1.2l5.2,3c0.3,0.2,0.7,0.2,1,0c0.3-0.2,0.5-0.5,0.5-0.9v-5.1c1.5-0.1,3,0.4,4.1,1.5
          c1.8,1.8,1.8,4.7,0,6.5L13.5,26c-0.3,0.3-0.3,0.9,0,1.2c0.2,0.2,0.4,0.3,0.6,0.3c0.2,0,0.4-0.1,0.6-0.3l1.7-1.7
          C18.7,23.3,18.7,18.3,16.8,16.4z" fill="#4CAF50" />
        </symbol>
      </defs>

      <rect width="100%" height="100%" fill="url(#backgroundGradient)" />
      <rect width="100%" height="100%" fill="url(#dustbinPattern)" opacity="0.3" />

      <g id="decorativeElements">
        <g id="connectedDots" opacity="0.6">
          <circle cx="100" cy="100" r="5" fill="#4CAF50" class="pulse-dot" />
          <circle cx="200" cy="150" r="5" fill="#4CAF50" />
          <circle cx="300" cy="120" r="5" fill="#4CAF50" class="pulse-dot" />
          <circle cx="400" cy="180" r="5" fill="#4CAF50" />
          <circle cx="500" cy="130" r="5" fill="#4CAF50" class="pulse-dot" />
          <circle cx="600" cy="160" r="5" fill="#4CAF50" />
          <circle cx="700" cy="110" r="5" fill="#4CAF50" />

          <line x1="100" y1="100" x2="200" y2="150" stroke="#4CAF50" stroke-width="1" opacity="0.5" />
          <line x1="200" y1="150" x2="300" y2="120" stroke="#4CAF50" stroke-width="1" opacity="0.5" />
          <line x1="300" y1="120" x2="400" y2="180" stroke="#4CAF50" stroke-width="1" opacity="0.5" />
          <line x1="400" y1="180" x2="500" y2="130" stroke="#4CAF50" stroke-width="1" opacity="0.5" />
          <line x1="500" y1="130" x2="600" y2="160" stroke="#4CAF50" stroke-width="1" opacity="0.5" />
          <line x1="600" y1="160" x2="700" y2="110" stroke="#4CAF50" stroke-width="1" opacity="0.5" />
        </g>

        <circle cx="150" cy="500" r="60" fill="#4CAF50" opacity="0.1" />
        <circle cx="650" cy="450" r="80" fill="#4CAF50" opacity="0.1" />
        <circle cx="750" cy="250" r="40" fill="#4CAF50" opacity="0.1" />
        <circle cx="50" cy="300" r="30" fill="#4CAF50" opacity="0.1" />

        <g transform="translate(100, 380) scale(1.5)">
          <use href="#recycleSymbol" width="40" height="40" opacity="0.7" />
        </g>

        <g transform="translate(700, 380) scale(1.5)">
          <use href="#recycleSymbol" width="40" height="40" opacity="0.7" />
        </g>

        <g id="dustbinSilhouettes" opacity="0.2">
          <path d="M200,400 L220,400 L225,500 L195,500 Z" fill="#333333" />
          <path d="M190,400 L230,400 L230,390 L190,390 Z" fill="#333333" />

          <path d="M400,430 L420,430 L425,530 L395,530 Z" fill="#333333" />
          <path d="M390,430 L430,430 L430,420 L390,420 Z" fill="#333333" />

          <path d="M600,410 L620,410 L625,510 L595,510 Z" fill="#33333As" />
          <path d="M590,410 L630,410 L630,400 L590,400 Z" fill="#333333" />

          <path d="M205,450 Q210,440 215,450" stroke="#333333" stroke-width="2" fill="none" />
          <path d="M200,455 Q210,430 220,455" stroke="#333333" stroke-width="2" fill="none" />

          <path d="M405,480 Q410,470 415,480" stroke="#333333" stroke-width="2" fill="none" />
          <path d="M400,485 Q410,460 420,485" stroke="#333333" stroke-width="2" fill="none" />

          <path d="M605,460 Q610,450 615,460" stroke="#333333" stroke-width="2" fill="none" />
          <path d="M600,465 Q610,440 620,465" stroke="#333333" stroke-width="2" fill="none" />
        </g>
      </g>

      <path d="M0,530 Q200,500 400,530 T800,530 V600 H0 Z" fill="#4CAF50" opacity="0.1" />
    </svg>
  </div>
  <header>
    <div class="header-container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="logo">
        <i class="fas fa-recycle"></i>
        <div class="logo-text">EcoSortha</div>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="https://wasteclassifier.vercel.app">Analytics</a></li>
          <li><a href="Dustbin.html" class="active">Dustbin</a></li>
          <li><a href="routeopt.html">Route Optimization</a></li>
          <li><a href="notification.html" id="nav-notifications">Notifications <span id="notifBadge" class="notif-badge" style="display:none">0</span></a></li>
          <li><a href="#">Settings</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <h1 class="text-3xl font-bold text-center text-gray-800 mb-10 relative pb-3">
      Smart Dustbin Monitor
      <span class="absolute bottom-0 left-1/2 -translate-x-1/2 w-3/4 max-w-xs h-1 bg-green-500 rounded-full"></span>
    </h1>

    <div class="grid md:grid-cols-3 gap-6 mb-8">
      
      <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm mb-1">Active Dustbins</p>
            <p class="text-3xl font-bold text-gray-800" id="statActiveBins">2/3</p>
          </div>
          <div class="bg-green-100 rounded-full p-4">
            <i class="fas fa-trash-alt text-2xl text-green-600"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm mb-1">Need Attention</p>
            <p class="text-3xl font-bold text-gray-800" id="needAttention">0</p>
          </div>
          <div class="bg-red-100 rounded-full p-4"> <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm mb-1">Last Updated</p>
            <p class="text-3xl font-bold text-gray-800" id="lastUpdated">--:--:--</p>
          </div>
          <div class="bg-blue-100 rounded-full p-4">
            <i class="fas fa-sync-alt text-2xl text-blue-600"></i>
          </div>
        </div>
      </div>
    </div>

    <div id="dustbinCardContainer" class="grid lg:grid-cols-3 gap-6 mt-10">

      <div class="bg-white rounded-xl shadow-lg p-6 text-center card-hover">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center justify-center gap-2">
          <i class="fas fa-trash-alt text-green-600"></i> Dustbin 1
        </h2>
        <div class="space-y-3 text-left">
          <div class="flex justify-between items-center p-3 border-b border-gray-100">
            <span class="text-gray-600">Distance:</span>
            <span class="font-bold text-gray-800"><span id="distance1">Loading...</span> cm</span>
          </div>
          <div class="flex justify-between items-center p-3 border-b border-gray-100">
            <span class="text-gray-600">Fill Percentage:</span>
            <span class="font-bold text-gray-800" id="fillPercent1">Loading...</span>
          </div>
        </div>
        <div class="fill-meter mt-5 mb-4">
          <div id="fillLevel1" class="fill-level"></div>
        </div>
        <div id="status1" class="status-badge default">Checking Status...</div>
        <span class="block text-right text-xs text-gray-400 mt-3" id="lastUpdated1">Updating...</span>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6 text-center card-hover">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center justify-center gap-2">
          <i class="fas fa-trash-alt text-green-600"></i> Dustbin 2
        </h2>
        <div class="space-y-3 text-left">
          <div class="flex justify-between items-center p-3 border-b border-gray-100">
            <span class="text-gray-600">Distance:</span>
            <span class="font-bold text-gray-800"><span id="distance2">Loading...</span> cm</span>
          </div>
          <div class="flex justify-between items-center p-3 border-b border-gray-100">
            <span class="text-gray-600">Fill Percentage:</span>
            <span class="font-bold text-gray-800" id="fillPercent2">Loading...</span>
          </div>
        </div>
        <div class="fill-meter mt-5 mb-4">
          <div id="fillLevel2" class="fill-level"></div>
        </div>
        <div id="status2" class="status-badge default">Checking Status...</div>
        <span class="block text-right text-xs text-gray-400 mt-3" id="lastUpdated2">Updating...</span>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6 text-center card-hover">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center justify-center gap-2">
          <i class="fas fa-trash-alt text-green-600"></i> Dustbin 3
        </h2>
        <div class="space-y-3 text-left">
          <div class="flex justify-between items-center p-3 border-b border-gray-100">
            <span class="text-gray-600">Distance:</span>
            <span class="font-bold text-gray-800"><span id="distance3">Loading...</span> cm</span>
          </div>
          <div class="flex justify-between items-center p-3 border-b border-gray-100">
            <span class="text-gray-600">Fill Percentage:</span>
            <span class="font-bold text-gray-800" id="fillPercent3">Loading...</span>
          </div>
        </div>
        <div class="fill-meter mt-5 mb-4">
          <div id="fillLevel3" class="fill-level"></div>
        </div>
        <div id="status3" class="status-badge default">Checking Status...</div>
        <span class="block text-right text-xs text-gray-400 mt-3" id="lastUpdated3">Updating...</span>
      </div>

    </div>
  </main>

  <footer class="bg-white mt-12 py-6 border-t">
    <div class="max-w-7xl mx-auto px-4 text-center text-gray-600">
      <p>Smart Waste Management System by Team Gliders</p>
      <p class="text-sm mt-1">Â© 2025 All Rights Reserved</p>
    </div>
  </footer>

  <div class="chatbot-section">
    <div class="chatbot-toggle" id="chatToggle">
      <i class="fas fa-comments"></i>
      <span class="notification-badge" id="notificationBadge">1</span>
    </div>
    <div class="chatbot-container" id="chatContainer">
      <div class="chatbot-header">
        <h3><i class="fas fa-robot"></i> Smart Assistant</h3>
        <div class="close-chat" id="closeChat"><i class="fas fa-times"></i></div>
      </div>
      <iframe height="430" width="350" src="https://bot.dialogflow.com/6fe817bb-e400-4897-b0f6-aa16e24d741e" class="border-none"></iframe>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // LOCAL STORAGE KEY
    const BIN_STATE_KEY = 'ECO_BIN_STATE_v1';
    const NOTIF_KEY = 'ECO_NOTIFICATIONS_v1';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDukH2UaAqphv9Tzc128i88W_WHJo9QBnI",
      authDomain: "smartdustbin-696a9.firebaseapp.com",
      databaseURL: "https://smartdustbin-696a9-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smartdustbin-696a9",
      storageBucket: "smartdustbin-696a9.appspot.com",
      messagingSenderId: "60628434159",
      appId: "1:60628434159:web:3a47cbdb8c66fcbf686f1a",
      measurementId: "G-DP9JLDFMQC"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Helpers
    function safeParse(jsonStr, fallback) {
      try { return JSON.parse(jsonStr); } catch(e) { return fallback; }
    }

    function loadBinState() {
      const raw = localStorage.getItem(BIN_STATE_KEY);
      if (!raw) {
        // default structure
        const defaultState = {
          bin1: { distance: 120, fillPercent: 25 },
          bin2: { distance: 60, fillPercent: 55 },
          bin3: { distance: 20, fillPercent: 85 },
          lastUpdated: new Date().toISOString()
        };
        localStorage.setItem(BIN_STATE_KEY, JSON.stringify(defaultState));
        return defaultState;
      }
      return safeParse(raw, {});
    }

    function saveBinState(state) {
      localStorage.setItem(BIN_STATE_KEY, JSON.stringify(state));
      updateStatCards();
      updateHeaderNotifBadge();
    }

    // Function to update dustbin status on the UI
    function updateDustbinUI(binNumber, data) {
      const distanceElem = document.getElementById(`distance${binNumber}`);
      const fillPercentElem = document.getElementById(`fillPercent${binNumber}`);
      const fillLevelElem = document.getElementById(`fillLevel${binNumber}`);
      const statusElem = document.getElementById(`status${binNumber}`);
      const lastUpdatedElem = document.getElementById(`lastUpdated${binNumber}`);

      if (data) {
        const distance = data.distance ?? 'No data';
        const fillPercent = (typeof data.fillPercent === 'number') ? data.fillPercent : (data.fillPercent ? parseFloat(data.fillPercent) : 'No data');

        distanceElem.textContent = `${distance}`;
        fillPercentElem.textContent = (fillPercent === 'No data') ? 'No data' : `${fillPercent}%`;
        fillLevelElem.style.width = (fillPercent === 'No data') ? '0%' : `${fillPercent}%`;

        fillLevelElem.className = 'fill-level';
        if (fillPercent === 'No data') {
          statusElem.textContent = 'No data';
          statusElem.className = 'status-badge default';
        } else if (fillPercent < 40) {
          fillLevelElem.classList.add('low');
          statusElem.textContent = "Status: Low";
          statusElem.className = "status-badge low";
        } else if (fillPercent < 80) {
          fillLevelElem.classList.add('medium');
          statusElem.textContent = "Status: Medium";
          statusElem.className = "status-badge medium";
        } else {
          fillLevelElem.classList.add('high');
          statusElem.textContent = "Status: Full!";
          statusElem.className = "status-badge high";
        }
        lastUpdatedElem.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      } else {
        distanceElem.textContent = 'No data';
        fillPercentElem.textContent = 'No data';
        fillLevelElem.style.width = '0%';
        fillLevelElem.className = 'fill-level';
        statusElem.textContent = 'No data';
        statusElem.className = 'status-badge default';
        lastUpdatedElem.textContent = 'No data';
      }
    }

    // Update stat cards
    function updateStatCards() {
      const state = loadBinState();
      const bins = ['bin1','bin2','bin3'];
      let attention = 0;
      let active = 0;
      bins.forEach((b, i) => {
        const data = state[b];
        if (data && typeof data.fillPercent === 'number') {
          active++;
          if (data.fillPercent >= 80) attention++;
        }
        updateDustbinUI(i+1, data);
      });
      document.getElementById('needAttention').textContent = attention;
      document.getElementById('statActiveBins').textContent = `${active}/${bins.length}`;
      document.getElementById('lastUpdated').textContent = new Date(state.lastUpdated || Date.now()).toLocaleTimeString();
    }

    // Firebase listeners -> update both UI and localStorage
    const binDataRef = db.ref('/binData');

    binDataRef.child('bin1').on('value', (snapshot) => {
      const val = snapshot.val();
      const state = loadBinState();
      if (val) {
        state.bin1 = { distance: val.distance ?? state.bin1?.distance ?? 0, fillPercent: typeof val.fillPercent === 'number' ? val.fillPercent : parseFloat(val.fillPercent || state.bin1?.fillPercent || 0) };
      }
      state.lastUpdated = new Date().toISOString();
      saveBinState(state);
      updateStatCards();
    });

    binDataRef.child('bin2').on('value', (snapshot) => {
      const val = snapshot.val();
      const state = loadBinState();
      if (val) {
        state.bin2 = { distance: val.distance ?? state.bin2?.distance ?? 0, fillPercent: typeof val.fillPercent === 'number' ? val.fillPercent : parseFloat(val.fillPercent || state.bin2?.fillPercent || 0) };
      }
      state.lastUpdated = new Date().toISOString();
      saveBinState(state);
      updateStatCards();
    });

    binDataRef.child('bin3').on('value', (snapshot) => {
      const val = snapshot.val();
      const state = loadBinState();
      if (val) {
        state.bin3 = { distance: val.distance ?? state.bin3?.distance ?? 0, fillPercent: typeof val.fillPercent === 'number' ? val.fillPercent : parseFloat(val.fillPercent || state.bin3?.fillPercent || 0) };
      }
      state.lastUpdated = new Date().toISOString();
      saveBinState(state);
      updateStatCards();
    });

    // If Firebase isn't available or on initial load, apply saved state
    window.addEventListener('load', () => {
      const state = loadBinState();
      if (state) {
        // update UI immediately
        updateStatCards();
      }
      updateHeaderNotifBadge();
    });

    // Chatbot functionality
    const chatToggle = document.getElementById('chatToggle');
    const chatContainer = document.getElementById('chatContainer');
    const closeChat = document.getElementById('closeChat');
    const notificationBadge = document.getElementById('notificationBadge');

    chatToggle.addEventListener('click', () => {
      chatContainer.classList.toggle('active');
      notificationBadge.style.display = 'none';
    });

    closeChat.addEventListener('click', () => {
      chatContainer.classList.remove('active');
    });

    notificationBadge.style.display = 'none';

    // Notifications badge in header must reflect global notifications unread count
    function loadNotifications() {
      const raw = localStorage.getItem(NOTIF_KEY);
      try {
        if (!raw) return [];
        return JSON.parse(raw);
      } catch(e) { return []; }
    }
    function updateHeaderNotifBadge() {
      const list = loadNotifications();
      const unread = list.filter(n => !n.read).length;
      const badge = document.getElementById('notifBadge');
      if (!badge) return;
      if (unread > 0) {
        badge.style.display = 'inline-flex';
        badge.textContent = unread > 99 ? '99+' : unread;
      } else {
        badge.style.display = 'none';
      }
    }

    // Keep header badge in sync when navigating away
    window.addEventListener('storage', (e) => {
      if (e.key === NOTIF_KEY) updateHeaderNotifBadge();
    });

    // Save bin state periodically
    setInterval(() => {
      const state = loadBinState();
      saveBinState(state);
    }, 30000);

  </script>
</body>
</html>